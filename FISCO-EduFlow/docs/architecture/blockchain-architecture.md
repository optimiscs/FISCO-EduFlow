# 学链通区块链架构设计文档

## 1. 项目概述

学链通是一个基于FISCO BCOS的学历全流程管理认证系统，采用"联盟主链 + 联盟侧链 + 状态通道"三层混合架构，集成了椭圆曲线签名（ECDSA）、SHA256哈希、Merkle Tree、可验证随机函数（VRF）共识以及零知识证明（ZKP）等核心技术。

### 1.1 核心特性

- **多链架构**：主链+侧链的分层架构设计，支持跨链数据同步
- **状态通道**：链下高频交互和实时通信，支持数字人民币交易
- **节点权限管理**：三类节点（管理节点、用户节点、私有节点）的权限分级
- **密码学安全**：SHA256哈希算法和ECDSA数字签名保证数据完整性
- **智能合约系统**：自动化的认证流程和规则执行

## 2. 区块结构设计

### 2.1 区块头结构（76字节）

```
┌─────────────────────────────────────────────────────────────────┐
│                        区块头结构                                │
├─────────────────────────────────────────────────────────────────┤
│ 上一个区块哈希值 (32字节)                                        │
├─────────────────────────────────────────────────────────────────┤
│ Merkle根哈希值 (32字节)                                         │
├─────────────────────────────────────────────────────────────────┤
│ 时间戳 (4字节) │ 难度值 (4字节) │ 随机数 (4字节)                │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 区块体结构

区块体由交易列表构成，每个交易包含：
- 发送方地址
- 接收方地址
- 交易金额
- 交易数据
- 数字签名
- 交易哈希
- 时间戳
- 交易类型（学历认证、查询等）

### 2.3 交易流程

1. 用户进行交易，系统自动利用用户的私钥签署数字签名
2. 将签名附加在交易末尾，制作成交易单
3. 将交易单广播至全网
4. 多个节点形成完整链条，进行信息传递与数据交易

## 3. 密码学算法

### 3.1 SHA256哈希算法

SHA256是构造区块链所用的主要密码哈希函数：
- 对于长度小于2^64位的消息，SHA256会产生一个256位的消息摘要
- 无论是区块的头部信息还是交易数据，都使用这个哈希函数计算相关数据的哈希值
- 保证数据的完整性

**实现位置**：`services/crypto/internal/crypto/hash.go`

### 3.2 ECDSA数字签名

数字签名是为了作为发送者的证明并且证明信息没有被篡改：
- 采用椭圆曲线数字签名的方法
- 使用secp256k1曲线
- 支持交易签名、学历数据签名、区块头签名等

**实现位置**：`services/crypto/internal/crypto/ecdsa.go`

## 4. 节点权限管理

### 4.1 节点类型

在本系统的联盟链中节点分为三类：

#### 4.1.1 管理节点（MANAGEMENT）
- **主要组成**：教育部门
- **权限**：
  - 可以向底层区块链中写入数据、更新数据
  - 为用户节点分配权限
  - 注册新节点、暂停节点
  - 审批交易、管理证书

#### 4.1.2 用户节点（USER）
- **主要组成**：学生、企业等普通用户
- **权限**：
  - 只参与交易享受服务，不参与底层数据的更新记录
  - 可以查看链上记录的数据，读取相应的交易记录
  - 提交交易、查看证书、请求服务

#### 4.1.3 私有节点（PRIVATE）
- **主要组成**：将私有资源贡献出来加入联盟链的用户
- **权限**：
  - 拥有创建节点，修改自己所拥有节点的相关底层数据，更新数据等权利
  - 不参与全部底层数据的记录更新
  - 管理自有节点、写入自有数据

### 4.2 权限管理实现

**实现位置**：`backend/xuelian-blockchain-integration/src/main/java/com/xueliantong/blockchain/service/NodePermissionService.java`

## 5. 主链侧链架构

### 5.1 架构设计

采用"主链+侧链"的双链混合模式：

```
┌─────────────────────────────────────────────────────────────────┐
│                        主链 (Group 1)                           │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ • 学生档案合约 (StudentProfileContract)                    │ │
│  │ • 认证合约 (CertificationContract)                         │ │
│  │ • Merkle同步合约 (MerkleSyncContract)                      │ │
│  │ • 状态通道工厂 (StateChannelFactory)                       │ │
│  │ • 跨链路由合约 (CrossChainRouter)                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │ 跨链同步
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        侧链系统                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │  教育认证侧链   │  │  就业认证侧链   │  │  专业认证侧链   │  │
│  │   (Group 2)     │  │   (Group 3)     │  │   (Group 4)     │  │
│  │                 │  │                 │  │                 │  │
│  │ • 学历学位认证  │  │ • 就业认证      │  │ • 专业技能认证  │  │
│  │ • 成绩单管理    │  │ • 职业认证      │  │ • 资格证书      │  │
│  │ • 毕业证书      │  │ • 实习证明      │  │ • 培训证明      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 主链功能

- **学生档案管理**：存储核心学生信息和学历记录
- **认证流程控制**：管理认证申请和审批流程
- **跨链数据同步**：自动同步关键数据到主链
- **状态通道管理**：管理链下通道的生命周期

### 5.3 侧链功能

- **教育认证侧链**：专门处理学历学位认证
- **就业认证侧链**：处理就业和职业认证
- **专业认证侧链**：处理专业技能和资格认证

### 5.4 跨链实现

**实现位置**：`backend/xuelian-blockchain-integration/src/main/java/com/xueliantong/blockchain/service/CrossChainService.java`

## 6. 状态通道系统

### 6.1 数字人民币状态通道

状态通道建立在学生节点和代理机构节点之间，利用数字人民币进行交易和价值流转。

#### 6.1.1 交易流程

1. **开辟通道**：交易方在链上通过浏览器钱包锁定一定量的资产，在区块链上记录并开辟状态通道
2. **链下交易**：在通道内进行相互交易和状态更新，但不提交到链上
3. **关闭通道**：当任一方想要关闭通道时，提交最终状态到区块链上进行清算
4. **争议仲裁**：若另一方有异议，可在规定时间内申请链上仲裁

#### 6.1.2 应用场景

- **小额多次的认证收费**：学历验证费用、证书查询费用
- **数字人民币交易**：学生与企业间的费用结算
- **实时通信**：求职申请、面试邀请、录用通知、合同签署

### 6.2 实现架构

**Java服务**：`backend/xuelian-blockchain-integration/src/main/java/com/xueliantong/blockchain/service/StateChannelService.java`

**智能合约**：`blockchain/contracts/contracts/DigitalCurrencyChannel.sol`

## 7. 智能合约系统

### 7.1 合约架构

```
智能合约系统
├── 区块结构合约 (BlockStructure.sol)
│   ├── 区块头管理
│   ├── 交易处理
│   └── Merkle树计算
├── 学生档案合约 (StudentProfileContract.sol)
│   ├── 学生信息管理
│   ├── 学历记录存储
│   └── 隐私保护
├── 认证合约 (CertificationContract.sol)
│   ├── 认证申请处理
│   ├── 审批流程管理
│   └── 证书发放
├── 状态通道工厂 (StateChannelFactory.sol)
│   ├── 通道创建
│   ├── 参与者管理
│   └── 资金托管
├── 状态通道合约 (StateChannelContract.sol)
│   ├── 通道生命周期
│   ├── 状态更新
│   └── 争议解决
├── 数字人民币通道 (DigitalCurrencyChannel.sol)
│   ├── 资产锁定
│   ├── 链下交易
│   └── 最终清算
└── 跨链路由合约 (CrossChainRouter.sol)
    ├── 消息路由
    ├── 链间验证
    └── 状态同步
```

### 7.2 合约特性

- **自动化执行**：智能合约自动执行认证流程和规则
- **多方签名**：支持多方签名验证机制
- **事件触发**：基于事件的自动化流程控制
- **权限控制**：基于角色的访问控制机制

## 8. 系统集成

### 8.1 技术栈

- **区块链平台**：FISCO BCOS 3.2.0
- **智能合约**：Solidity ^0.8.0
- **后端框架**：Spring Boot 3.2.0 + Java 17
- **区块链SDK**：FISCO BCOS Java SDK
- **密码学服务**：Go 1.19+ (辅助服务)
- **数据库**：H2 (开发) / SQL Server (生产)
- **缓存**：Redis
- **消息队列**：RabbitMQ

### 8.2 服务架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      前端应用层                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                      API网关层                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                    业务服务层                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  用户管理   │  │  认证流程   │  │ 区块链集成  │              │
│  │   模块      │  │    模块     │  │    模块     │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                  区块链服务层                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  智能合约   │  │  跨链服务   │  │ 状态通道    │              │
│  │   服务      │  │    服务     │  │   服务      │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                  FISCO BCOS 区块链网络                          │
└─────────────────────────────────────────────────────────────────┘
```

## 9. 安全特性

### 9.1 数据安全

- **哈希完整性**：使用SHA256确保数据完整性
- **数字签名**：ECDSA签名验证身份和防篡改
- **权限控制**：基于节点类型的分级权限管理
- **隐私保护**：零知识证明和选择性信息披露

### 9.2 网络安全

- **联盟链架构**：受控的网络访问和节点管理
- **多重验证**：多方签名和共识机制
- **防重放攻击**：使用nonce机制防止重放
- **争议解决**：链上仲裁和自动化争议处理

## 10. 监控和运维

### 10.1 健康检查

**实现位置**：`backend/xuelian-blockchain-integration/src/main/java/com/xueliantong/blockchain/actuator/BlockchainHealthIndicator.java`

监控指标包括：
- 主链和侧链的区块高度
- 节点连接状态和数量
- 智能合约可用性
- 跨链消息处理状态
- 状态通道活跃度
- 节点权限服务状态

### 10.2 性能指标

- **TPS**：每秒交易处理数量
- **响应时间**：交易确认时间
- **区块生成时间**：平均出块间隔
- **跨链延迟**：跨链消息处理时间
- **状态通道吞吐量**：链下交易处理能力

## 11. 部署架构

### 11.1 网络拓扑

```
┌─────────────────────────────────────────────────────────────────┐
│                      生产环境部署                                │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   主链节点  │  │   侧链节点  │  │  应用服务   │              │
│  │             │  │             │  │             │              │
│  │ Node0-Node3 │  │ Node0-Node1 │  │ Spring Boot │              │
│  │ (Group 1)   │  │ (Group 2,3) │  │   + Go      │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                │                │                     │
│         └────────────────┼────────────────┘                     │
│                          │                                      │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                   基础设施层                                │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │ │
│  │  │    Redis    │  │  RabbitMQ   │  │ SQL Server  │          │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 11.2 容器化部署

使用Docker和Docker Compose进行容器化部署，支持：
- 自动化部署和扩展
- 服务发现和负载均衡
- 健康检查和故障恢复
- 配置管理和密钥管理

## 12. 总结

学链通区块链架构通过以下创新设计实现了高效、安全、可扩展的学历认证系统：

1. **三层混合架构**：主链+侧链+状态通道的分层设计
2. **节点权限分级**：管理节点、用户节点、私有节点的差异化权限
3. **数字人民币集成**：支持链下高频交易和价值流转
4. **密码学安全**：SHA256+ECDSA的双重安全保障
5. **智能合约自动化**：全流程自动化的认证和管理
6. **跨链数据同步**：主链与侧链间的无缝数据交换
7. **企业级运维**：完整的监控、日志和健康检查体系

该架构充分利用了FISCO BCOS的企业级特性，实现了真正的产业级区块链教育认证平台，支持大规模部署和高并发访问。

## 13. WebAssembly智能合约系统

### 13.1 WASM合约架构

学链通采用基于WebAssembly（WASM）语言编写的混合模式智能合约，包含以下核心要素：

#### 13.1.1 数据类型系统
- **无符号整数uint**：用于ID、时间戳、计数器等
- **结构体struct**：学生信息、审核者信息、供应商信息等复杂数据结构
- **字符串string**：姓名、手机号、学历信息等文本数据
- **布尔bool**：注册状态、审核状态等标志位
- **映射mapping**：地址到信息的映射关系
- **地址address**：区块链账户地址

#### 13.1.2 状态变量管理
状态变量用于表示合约的状态，其变化过程表示了合约的生命历程：
- 学生信息映射：`mapping(string => Student) public students`
- 审核者映射：`mapping(address => Auditor) public auditors`
- 供应商映射：`mapping(address => Supplier) public supplierMap`
- 身份证号注册状态：`mapping(string => bool) public idCardRegistered`

#### 13.1.3 函数分类
- **内部调用函数**：消息认证、加密处理、调用状态变量等
- **外部调用函数**：通过JSON-RPC接口在外部调用的函数

#### 13.1.4 执行机制
1. 区块链为每个用户分发公钥和私钥
2. 公钥作为用户在区块链上的账户地址
3. 私钥作为用户加密的密钥
4. 认证双方协定智能合约
5. 双方用各自私钥签名确认合约信息
6. 合约通过P2P网络传入区块链
7. 认证节点验证合约，共识完成后存入数据区块并自动执行

### 13.2 学籍信息上链合约算法

**实现位置**：`blockchain/contracts/contracts/WASMStudentRegistry.sol`

```
算法流程：
输入: 学生姓名std_name, 学生手机号std_phone, 学生身份证号std_id,
     学生学历信息std_info, 时间戳timestamp
输出: 数据上链完成或失败

具体步骤：
1. 要求身份证号未被录入
2. 要求通过审核
3. if supplierMap[msg.sender].id == 0 || supplierMap[msg.audit].re == False then
4.   return FALSE
5. end if
6. std.stdID = std_id
7. std.stdName = std_name
8. std.stdPhone = std_phone
9. std.stdInfo = std_info
10. final
11. return True
```

## 14. 数据同步验证系统

### 14.1 主侧链数据同步机制

由于联盟主链与联盟侧链是两条权限不同的区块链，链上数据必须同步：

#### 14.1.1 MerkleTree算法应用
1. **哈希锁定**：使用MerkleTree算法进行哈希锁定，生成hash值
2. **区块链身份证**：该hash成为用户"区块链身份证"的属性
3. **同步到侧链**：将MerkleRoot同步到联盟侧链
4. **篡改检测**：一旦学籍信息被篡改，Merkle Root也会随之改变

#### 14.1.2 叶子节点构建
- **主链节点**：高校、教育部上传的信息作为Merkle Tree的叶子节点
- **侧链节点**：代理机构等节点上传的信息作为叶子节点
- **哈希计算**：计算各节点信息的哈希值(H1,H2，...)
- **两两运算**：对(H1,H2，...)进行两两哈希运算求哈希值
- **循环计算**：如此循环，直至得到根哈希MerkleRoot

#### 14.1.3 篡改检测与定位
- **快速定位**：监管方通过Merkle Tree算法快速定位被篡改数据来自哪一分支
- **追责机制**：对应到主链和侧链中的具体环节进行追责
- **验证流程**：用人单位验证学历信息时，使用同样方法得到MerkleRoot与可靠值比较

**实现位置**：`blockchain/contracts/contracts/MerkleSyncContract.sol`

## 15. 认证合约流程

### 15.1 六步认证算法

根据学位、学历认证智能合约模型，结合传统学位学历认证流程：

#### Step1：达成共识
学生与用人单位就需提供的信息等标准参数达成共识

#### Step2：确认意向
学生与用人单位达成认证意向

#### Step3：数据确认
学生确认输出的部分数据，发送认证消息给用人单位

#### Step4：生成合约
认证双方确认合约信息，生成合约

#### Step5：PDF生成与执行
PDF文件生成，并在链中完成共识，将执行函数导入区块，并根据结束条件完成清算

#### Step6：完成执行
转发PDF文件，完成合约执行

**实现位置**：`blockchain/contracts/contracts/CredentialCertificationContract.sol`

## 16. 移动设备共识机制

### 16.1 高吞吐量共识协议

采用基于移动设备的高吞吐量共识协议，仅需智能手机即可参与区块验证和共识：

#### 16.1.1 节点类型
**普通节点**：
- 在智能手机上运行
- 通过TEE（可信硬件）认证参与者身份
- 强制每个TEE在区块链上最多具有一个活动身份
- 数量大，资源有限
- 仅参与投票共识

**超级节点**：
- 在服务器上运行
- 数量少，资源丰富
- 主要进行存储等资源消耗量大的工作
- 存储账本和密钥值数据库
- 普通节点根据需要从超级节点获取数据

#### 16.1.2 TEE认证机制
- 使用智能手机上的可信硬件（TEE）认证参与者身份
- 防止身份伪造和重复注册
- 确保每个物理设备只能有一个活跃身份

**实现位置**：`blockchain/contracts/contracts/MobileConsensusContract.sol`

## 17. CA认证体系

### 17.1 证书颁发机构管理

通过证书颁发机构（CA, Certificate Authority）进行管理和操作：

#### 17.1.1 第三方节点认证
- **问题**：加入系统的节点较多，难以保证节点的官方性
- **解决方案**：采用CA认证对第三方节点进行认证管理，防止节点作恶

#### 17.1.2 电子学历证书认证
- **问题**：电子证书的认证存在诸多问题
- **解决方案**：CA认证与区块链"数字签名"结合
- **目标**：防止电子层面的造假，提高防伪性

### 17.2 超级节点申请流程

#### 17.2.1 申请提交
超级节点申请者提出申请，提供所需的基本信息

#### 17.2.2 智能合约处理
客户端把请求提交给智能合约，智能合约将请求发给所有CA节点

#### 17.2.3 背书策略
根据背书策略，背书节点模拟执行交易请求

#### 17.2.4 排序与广播
排序节点收集背书节点的结果打包成交易事务列表进行广播

#### 17.2.5 验证与确认
节点进行有效性和一致性验证，结果一致则记录进当前节点

#### 17.2.6 同步更新
其他节点同步已确认节点的信息，验证后加入到自己节点的账本中

**实现位置**：`blockchain/contracts/contracts/CAAuthenticationContract.sol`

## 18. 完整技术栈总结

### 18.1 核心技术组件

```
学链通技术架构
├── 区块链层
│   ├── FISCO BCOS 3.2.0 (联盟链平台)
│   ├── WebAssembly智能合约 (WASM)
│   ├── 主链+侧链架构
│   └── 状态通道 (数字人民币)
├── 密码学层
│   ├── SHA256哈希算法
│   ├── ECDSA数字签名 (secp256k1)
│   ├── Merkle Tree (数据完整性)
│   └── 零知识证明 (隐私保护)
├── 共识层
│   ├── 移动设备共识协议
│   ├── TEE硬件认证
│   ├── 普通节点 (智能手机)
│   └── 超级节点 (服务器)
├── 权限层
│   ├── 管理节点 (教育部门)
│   ├── 用户节点 (学生/企业)
│   ├── 私有节点 (资源贡献者)
│   └── CA认证体系
├── 应用层
│   ├── Spring Boot 3.2.0
│   ├── Java 17
│   ├── Go 1.19+ (密码学服务)
│   └── React (前端)
└── 基础设施层
    ├── Redis (缓存)
    ├── RabbitMQ (消息队列)
    ├── SQL Server (数据库)
    └── Docker (容器化)
```

### 18.2 创新特性总结

1. **WebAssembly智能合约**：图灵完备的混合模式智能合约
2. **移动设备共识**：智能手机参与区块验证和共识
3. **三层混合架构**：主链+侧链+状态通道的分层设计
4. **数字人民币集成**：链下高频交易和价值流转
5. **CA认证体系**：第三方节点认证和电子证书防伪
6. **MerkleTree同步**：主侧链数据同步和篡改检测
7. **六步认证流程**：完整的学历认证智能合约算法
8. **TEE硬件认证**：基于可信硬件的身份认证

该架构实现了真正的产业级区块链教育认证平台，具备高安全性、高可扩展性和高可用性，支持大规模部署和高并发访问。
